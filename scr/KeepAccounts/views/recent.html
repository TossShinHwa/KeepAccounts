{{layout "layout"}}

<script type="text/javascript">
    String.prototype.Format = function () {
        var fmt = "yyyy-MM-dd";
        var myDate = ConvertJsonDate(this);
        var o = {
            "M+": myDate.getMonth() + 1,
            "d+": myDate.getDate(),
            "h+": myDate.getHours(),
            "m+": myDate.getMinutes(),
            "s+": myDate.getSeconds(),
            "q+": Math.floor((myDate.getMonth() + 3) / 3),
            "S": myDate.getMilliseconds()
        };
        if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (myDate.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (var k in o)
            if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
    };

    Date.prototype.Format = function () {
        var fmt = "yyyy-MM-dd";
        var myDate = this;
        var o = {
            "M+": myDate.getMonth() + 1,
            "d+": myDate.getDate(),
            "h+": myDate.getHours(),
            "m+": myDate.getMinutes(),
            "s+": myDate.getSeconds(),
            "q+": Math.floor((myDate.getMonth() + 3) / 3),
            "S": myDate.getMilliseconds()
        };
        if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (myDate.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (var k in o)
            if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
    };
    
    function ConvertJsonDate(jsondate) {
        jsondate = jsondate.replace("/Date(", "").replace(")/", "");
        if (jsondate.indexOf("+") > 0) {
            jsondate = jsondate.substring(0, jsondate.indexOf("+"));
        } else if (jsondate.indexOf("-") > 0) {
            jsondate = jsondate.substring(0, jsondate.indexOf("-"));
        }
        return new Date(parseInt(jsondate, 10));
    }
    
    function IsNum(s) {
        if (s != null && s != "") {
            return !isNaN(s);
        }
        return false;
    }

    function ViewModel() {
        var self = this;
        self.existingList = ko.observableArray();
        self.majorCategories = ko.observable();
        self.subCategories = ko.observable();
        self.originalData = ko.observable();
        self.list = ko.observableArray();

        self.add = function() {
            self.list.push(self.createItem());
        };

        self.save = function() {
            alert("1");
        };

        self.generate = function() {
            var array = self.originalData().split('\n');
            var day;
            ko.utils.arrayForEach(array, function(data) {
                if (IsNum(data)) {
                    day = new Date();
                    day.setDate(data);
                } else {
                    var index = 0;
                    var desc, money;
                    ko.utils.arrayForEach(data, function(c) {
                        if (IsNum(c)) {
                            desc = data.substring(0, index);
                            money = data.substring(index);
                        } else {
                            index++;
                        }
                    });

                    var item = self.createItem();

                    item.Desc = desc;
                    item.Money = money;
                    item.Date = day.Format();

                    self.list.push(item);
                }
            });
        };

        self.createItem = function() {
            var item = {
                "Desc": '',
                "Money": '',
                "Date": '',
                "selectedType": ko.observable(1),
                "selectedMajorCategory": ko.observable(),
                "selectedSubCategory": ko.observable(),
                optionalMajorCategories: ko.observableArray(),
                optionalSubCategories: ko.observableArray()
            };

            item.selectedType.subscribe(function(newValue) {
                var list = [];
                list.unshift({});
                ko.utils.arrayForEach(self.majorCategories(), function (o) {
                    if (newValue == o.Type) {
                        list.push(o);
                    }
                });
                item.optionalMajorCategories(list);
            });

            item.selectedMajorCategory.subscribe(function(newValue) {
                var list = [];
                list.unshift({});
                ko.utils.arrayForEach(self.subCategories(), function (o) {
                    if (newValue == o.MajorId) {
                        list.push(o);
                    }
                });
                item.optionalSubCategories(list);
            });

            return item;
        };

        $.getJSON('/data/list', self.existingList);

        $.getJSON('/data/majorCategory', self.majorCategories)
            .done(function() {
                $.getJSON('/data/subCategory', self.subCategories)
                    .done(function () {
                        self.add();
                    });
            });
    }

    $(document).ready(function () {
        ko.applyBindings(new ViewModel());
    });
</script>

<table class="table" style="width:600px;">
    <thead>
        <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Major</th>
            <th>Sub</th>
            <th>Desc</th>
            <th>Money</th>
        </tr>
    </thead>
    <tbody>
        <!-- ko foreach: existingList -->
        <tr data-bind="css: $data.type == '收入' ? 'success' : 'warning'">
            <td data-bind="html: $data.Date"></td>
            <td data-bind="html: $data.type"></td>
            <td data-bind="html: $data.MajorCategoryName"></td>
            <td data-bind="html: $data.SubCategoryCode"></td>
            <td data-bind="html: $data.Description"></td>
            <td data-bind="html: $data.Money"></td>
        </tr>
        <!-- /ko -->
        <!-- ko foreach: list -->
        <tr>
            <td><input type="text" style="width:80px;" data-bind="value: $data.Date"/></td>
            <td>
                <select style="width:80px;" data-bind="value: $data.Type, value: $data.selectedType">
                    <option value="1">支出</option>
                    <option value="0">收入</option>
                </select>
            </td>
            <td>
                <select name="a" style="width:100px;" data-bind="options: $data.optionalMajorCategories(), optionsText: 'Name', optionsValue: 'Id', value: $data.selectedMajorCategory">
                </select>
            </td>
            <td>
                <select style="width:100px;" data-bind="options: $data.optionalSubCategories(), optionsText: 'Name', optionsValue: 'Id', value: $data.selectedSubCategory">
                </select>
            </td>
            <td><input type="text" style="width:80px;" data-bind="value: $data.Desc"/></td>
            <td><input type="text" style="width:80px;" data-bind="value: $data.Money"/></td>
        </tr>
        <!-- /ko -->
    </tbody>
</table>
<div>
    <input type="button" value="Add" data-bind="click: add" class="btn" />
    <input type="submit" value="Save" data-bind="click: save" class="btn btn-primary" />
</div>
<div style="margin-top: 30px;">
    <textarea rows="10" style="width: 400px;" data-bind="value: originalData"></textarea>
    <input type="button" value="生成" data-bind="click: generate" class="btn btn-success" />
</div>