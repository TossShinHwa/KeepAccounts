{{layout "layout"}}

<script type="text/javascript">
    String.prototype.Format = function () {
        var fmt = "yyyy-MM-dd";
        var myDate = ConvertJsonDate(this);
        var o = {
            "M+": myDate.getMonth() + 1,
            "d+": myDate.getDate(),
            "h+": myDate.getHours(),
            "m+": myDate.getMinutes(),
            "s+": myDate.getSeconds(),
            "q+": Math.floor((myDate.getMonth() + 3) / 3),
            "S": myDate.getMilliseconds()
        };
        if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (myDate.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (var k in o)
            if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
    };

    Date.prototype.Format = function () {
        var fmt = "yyyy-MM-dd";
        var myDate = this;
        var o = {
            "M+": myDate.getMonth() + 1,
            "d+": myDate.getDate(),
            "h+": myDate.getHours(),
            "m+": myDate.getMinutes(),
            "s+": myDate.getSeconds(),
            "q+": Math.floor((myDate.getMonth() + 3) / 3),
            "S": myDate.getMilliseconds()
        };
        if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (myDate.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (var k in o)
            if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
    };
    
    function ConvertJsonDate(jsondate) {
        jsondate = jsondate.replace("/Date(", "").replace(")/", "");
        if (jsondate.indexOf("+") > 0) {
            jsondate = jsondate.substring(0, jsondate.indexOf("+"));
        } else if (jsondate.indexOf("-") > 0) {
            jsondate = jsondate.substring(0, jsondate.indexOf("-"));
        }
        return new Date(parseInt(jsondate, 10));
    }
    
    function ListViewModel() {
        var self = this;
        self.list = ko.observableArray();
        $.getJSON('/data/list',self.list);
    }

    function EditViewModel() {
        var self = this;
        self.list = ko.observableArray();
        self.originalData = ko.observable();

        self.build = function () {
            var array = self.originalData().split('\n');

            var day;
            ko.utils.arrayForEach(array, function (data) {
                if (IsNum(data)) {
                    day = new Date();
                    day.setDate(data);
                } else {
                    var index=0;
                    var desc, money;
                    ko.utils.arrayForEach(data, function(c) {
                        if (IsNum(c)) {
                            desc = data.substring(0, index);
                            money = data.substring(index);
                        } else {
                            index++;
                        }
                    });

                    self.list.push({
                        "Type": "支出",
                        "BigCategory": "",
                        "SmallCategory": "",
                        "Desc": desc,
                        "Money": money,
                        "Date": day.Format()
                    });
                }
            });
        };
    }
    
    $(document).ready(function () {
        ko.applyBindings(new ListViewModel(),$("#list")[0]);
        ko.applyBindings(new EditViewModel(), $("#edit")[0]);
    });
    
    //判断是否为数字
    function IsNum(s) {
        if (s != null && s != "") {
            return !isNaN(s);
        }
        return false;
    }
    
</script>

<div id="list" class="content">
    <ul>
        <li id="title">
            <div>Type</div>
            <div>Category</div>
            <div>Category</div>
            <div>Desc</div>
            <div>Money</div>
            <div>Date</div>
        </li>
        <li class="clear"></li>
    </ul>
    <ul data-bind="foreach:list">
        <li>
            <div data-bind="html:$data.type"></div>
            <div data-bind="html:$data.MajorCategoryName"></div>
            <div data-bind="html:$data.SubCategoryCode"></div>
            <div data-bind="html:$data.Description"></div>
            <div data-bind="html:$data.Money"></div>
            <div data-bind="html:$data.Date"></div>
        </li>
        <li class="clear"></li>
    </ul>
</div>

<div id="edit">
    <div>
        <textarea style="width: 400px; height: 200px;" data-bind="value: originalData"></textarea>
        <input type="button" value="生成" data-bind="click:build" />
    </div>

    <div class="content">
        <ul data-bind="template: { name: 'editItemTemplate', foreach: list }"></ul>
    </div>
</div>

<script type="text/html" id="editItemTemplate">
    <li>
        <div>
            <select style="width:80px;" data-bind="value: $data.Type">
                <option>支出</option>
                <option>收入</option>
            </select>
        </div>
        <div>
            <select style="width:80px;">
            </select>
        </div>
        <div>
            <select style="width:80px;">
            </select>
        </div>
        <div><input type="text" style="width:80px;" data-bind="value: $data.Desc"/></div>
        <div><input type="text" style="width:80px;" data-bind="value: $data.Money"/></div>
        <div><input type="text" style="width:80px;" data-bind="value: $data.Date"/></div>
    </li>
    <li class="clear"></li>
</script>